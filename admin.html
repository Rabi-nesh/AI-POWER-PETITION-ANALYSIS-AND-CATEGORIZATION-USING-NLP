<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
/* ---------------- YOUR CSS (unchanged) ---------------- */
body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #43cea2, #185a9d);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
}

header {
      width: 100%;
      background: rgba(0, 0, 0, 0.4);
      text-align: center;
      padding: 20px;
      font-size: 28px;
      font-weight: bold;
      letter-spacing: 1px;
}

/* ADD FILTER TABS */
.tabs {
      display: flex;
      gap: 20px;
      margin-top: 20px;
}

.tab {
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s;
}

.tab.active {
      background: rgba(255,255,255,0.5);
      font-weight: bold;
}

.tab:hover {
      background: rgba(255,255,255,0.35);
}

.container {
      margin-top: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      width: 100%;
      max-width: 1000px;
}

.card {
      background: white;
      color: #333;
      border-radius: 15px;
      width: 300px;
      min-height: 220px;
      display: flex;
      flex-direction: column;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      font-weight: bold;
      padding: 15px;
      position: relative;
}

button.delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff4b5c;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
}

button.delete-btn:hover {
      background: #e63946;
}

.status-dropdown {
      margin-top: 10px;
      padding: 5px;
      border-radius: 8px;
      border: none;
      background: #e0e0e0;
      font-weight: bold;
      cursor: pointer;
}

.add-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 300px;
      margin: 20px auto;
}

.add-form input, .add-form textarea {
      padding: 8px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
}

.add-form button {
      background: #43cea2;
      border: none;
      padding: 10px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-size: 16px;
}

.logout-btn {
      position: fixed;
      bottom: 30px;
      background: #ff4b5c;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
}
</style>
</head>
<body>

<header>Admin Panel</header>

<!-- FILTER TABS ADDED -->
<div class="tabs" id="tabs" style="display:none;">
    <div class="tab active" onclick="filterTab('all')">All</div>
    <div class="tab" onclick="filterTab('solved')">Solved</div>
    <div class="tab" onclick="filterTab('unsolved')">Unsolved</div>
    <div class="tab" onclick="filterTab('duplicate')">Duplicate</div>
    <div class="tab" onclick="showTab('add')">Add Petition</div>
</div>

<div id="loginBox" class="login-box">
<input type="text" id="username" placeholder="Username" value="">
<input type="password" id="password" placeholder="Password" value="">
<button onclick="login()">Login</button>
<div id="loginMsg"></div>
</div>

<div class="container" id="petitionContainer" style="display:none;"></div>

<div class="add-form" id="addForm" style="display:none;">
<input type="text" id="title" placeholder="Title">
<input type="text" id="name" placeholder="Name">
<input type="text" id="phone" placeholder="Phone">
<input type="text" id="address" placeholder="Address">
<textarea id="description" placeholder="Description"></textarea>
<button id="addBtn">Add Petition</button>
</div>

<button class="logout-btn" onclick="logout()" style="display:none;">Logout</button>


<script>
let token = '';
let user_id = '';
let currentFilter = "all";

async function login() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const res = await fetch('http://127.0.0.1:5000/api/admin/login',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username,password})
    });
    const data = await res.json();
    if(res.ok){
        token = data.token;
        user_id = data.user_id;
        localStorage.setItem('token', token);
        localStorage.setItem('user_id', user_id);

        document.getElementById('loginBox').style.display='none';
        document.getElementById('tabs').style.display='flex';
        document.querySelector('.logout-btn').style.display='block';

        showTab('petitions');
        loadPetitions("all");
    } else {
        document.getElementById('loginMsg').innerText = data.error || "Login failed";
    }
}

function filterTab(type){
    currentFilter = type;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    showTab('petitions');
    loadPetitions(type);
}

async function loadPetitions(filterType="all") {
    const res = await fetch('http://127.0.0.1:5000/api/admin/petitions',{
        headers:{'Authorization':'Bearer '+token}
    });

    const data = await res.json();
    const container = document.getElementById('petitionContainer');
    container.innerHTML = '';

    let filtered = data.petitions;

    if(filterType === "solved"){
        filtered = filtered.filter(p=>p.status === "Solved");
    } 
    else if(filterType === "unsolved"){
        filtered = filtered.filter(p=>p.status !== "Solved");
    }
    else if(filterType === "duplicate"){
        filtered = filtered.filter(p=>p.is_duplicate === true);
    }

    filtered.forEach(p=>{
        const div = document.createElement('div');
        div.className='card';

        div.innerHTML=`
            <h4>${p.title}</h4>
            <p>${p.name}</p>
            <p>${p.phone}</p>
            <p>${p.address}</p>
            <p>${p.description}</p>

            <p>Status: <b>${p.status || "Unsolved"}</b></p>

            <button style="padding:8px; margin-top:10px; background:#2ecc71; color:white; border:none; border-radius:8px;"
                onclick="markSolved(${p.id})">
                Mark Solved
            </button>

            <button class="delete-btn" data-id="${p.id}">Delete</button>
        `;
        container.appendChild(div);
    });

    document.querySelectorAll('.delete-btn').forEach(btn=>{
        btn.onclick = async ()=>{
            const pid = btn.dataset.id;
            const res = await fetch(`http://127.0.0.1:5000/api/petition/${pid}`,{
                method:'DELETE',
                headers:{'Authorization':'Bearer '+token}
            });
            if(res.ok) loadPetitions(currentFilter);
        }
    });
}

/* ⭐ FIXED FUNCTION */
async function markSolved(pid){
    await fetch(`http://127.0.0.1:5000/api/admin/petition/${pid}/solve`,{
        method:'PUT',
        headers:{
            'Authorization':'Bearer '+token
        }
    });

    loadPetitions(currentFilter);
}

document.getElementById('addBtn').onclick = async ()=>{
    const title = document.getElementById('title').value.trim();
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const description = document.getElementById('description').value.trim();

    const res = await fetch('http://127.0.0.1:5000/api/admin/petitions',{
        method:'POST',
        headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
        body:JSON.stringify({title,name,phone,address,description})
    });

    if(res.ok){
        showTab('petitions');
        loadPetitions("all");
    }
};

function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user_id');
    window.location.reload();
}

function showTab(tabName){
    document.getElementById('petitionContainer').style.display =
        tabName==='petitions' ? 'flex' : 'none';

    document.getElementById('addForm').style.display =
        tabName==='add' ? 'flex' : 'none';
}

/* ❌ YOUR OLD WRONG FUNCTION REMOVED  
   (kept your code above, only removed duplication) */

</script>


</body>
</html>
